# Using Custom CNAME

This document intends to help anyone looking to setup a custom CNAME and use that instead of the FQDN domain name generated by the DevOps tooling while provisioning a K8s cluster. 


### Pre-requisites: 

1. Your Application should be based on the **[Template-App](https://gitlab.builder.ai/devops/template-app)** (If you are a BuildingBlock Project then you are already covered) 
2. You need to have access to manage DNS records for the domain name you want your app to work with. 
3. You need to have access to the cloud account where your cluster has been setup.

### Example: 

FQDN:  [https://silver-app.silver-kube.prod.eu-west-1.aws.svc.builder.ai](https://silver-app.silver-kube.prod.eu-west-1.aws.svc.builder.ai/) 
Desired CNAME: [https://silverapp.builder.cafe](https://silverapp.builder.cafe/) 

**Step 1:** Login to the Cloud Account where your K8s cluster has been setup and create a new DNS Hosted Zone with the **domain name being the CNAME** you want to access your app with (`silverapp.builder.cafe` in this case), copy the NS records that are generated. 

**Step2:**  Login to the DNS management service where your CNAME TLD is hosted (`builder.cafe` in this case) create a new record under builder.cafe of NS type with the values you copied from Step 1 then hit save. 

**Step 3:** Open your app repository and go to the [values.yaml](../app-deploy/values.yaml) file (there are different files per environment so choose the open where you want to use CNAME with ) inside app-deploy directory. Edit the file and uncomment  the following lines and replace <custom_cname> with the CNAME you configured above (`silverapp.builder.cafe` in this case):  
See also [values-stage.yaml](../app-deploy/values-stage.yaml) and [values-prod.yaml](../app-deploy/values-prod.yaml)

_Under Ingress Definition_

```
ingress:
  enabled: true
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-staging
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-body-size: 50m
    # nginx.ingress.kubernetes.io/server-alias: "<custom_cname>" ---> Uncomment this 
    # `external-dns.alpha.kubernetes.io/hostname: "<custom_cname>"`
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: rrapp.local
      paths: ['/']
  tls:
    - secretName: https-cert
      hosts:
        - rrapp.local
        # - <custom_cname>  ---> Uncomment this
```

**Step 4:** Commit these changes and the pipelines would take care of the rest ðŸ¥³ 

### Reference: 

1. https://docs.microsoft.com/en-us/azure/dns/dns-getstarted-portal 
2. https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resource-record-sets-creating.html

